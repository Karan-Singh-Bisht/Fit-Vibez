<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pose Detection</title>
  </head>
  <body>
    <h1>Real-time Pose Detection</h1>
    <video id="video" autoplay></video>
    <p>Count: <span id="count">0</span></p>
    <p id="finalMessage" style="display: none; color: red">
      Session Ended. Final Count: <span id="finalCount"></span>
    </p>

    <script>
      const video = document.getElementById("video");
      const countDisplay = document.getElementById("count");
      const finalMessage = document.getElementById("finalMessage");
      const finalCountDisplay = document.getElementById("finalCount");

      let intervalId;
      let frameCount = 0;
      const frameSkip = 5; // Send every 5th frame to reduce load

      async function sendFrame() {
        frameCount++;
        if (frameCount % frameSkip !== 0) return; // Skip some frames for optimization

        const canvas = document.createElement("canvas"); // Create an off-screen canvas
        const ctx = canvas.getContext("2d");
        canvas.width = 320;
        canvas.height = 240;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL("image/jpeg", 0.5).split(",")[1];

        try {
          const response = await fetch(
            "https://pushup-poseestimation-2.onrender.com/process_frame/",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ image: imageData }),
            }
          );

          const data = await response.json();
          countDisplay.innerText = data.count;

          if (data.final) {
            clearInterval(intervalId); // Stop sending frames
            video.srcObject.getTracks().forEach((track) => track.stop()); // Stop webcam
            finalMessage.style.display = "block";
            finalCountDisplay.innerText = data.count;
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // Start camera and process frames
      navigator.mediaDevices
        .getUserMedia({ video: { width: 640, height: 480 } })
        .then((stream) => {
          video.srcObject = stream;
          intervalId = setInterval(sendFrame, 100); // Send frames every 100ms
        });

      // Reset session on page load
      window.onload = async () => {
        try {
          await fetch(
            "https://pushup-poseestimation-2.onrender.com/reset_session/",
            { method: "POST" }
          );
          console.log("Session reset successfully");
        } catch (error) {
          console.error("Error resetting session:", error);
        }
      };
    </script>
  </body>
</html>
